<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Property GPS System</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    .controls {
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      padding:10px; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,.15);
      z-index:1000;
    }
    .controls input { padding:6px 8px; border-radius:4px; border:1px solid #ccc; width:220px; }
    .controls button { background:#2563eb; color:#fff; border:none; padding:7px 10px; border-radius:6px; cursor:pointer; }
    .controls button:disabled { background:#999; cursor:not-allowed; }
    #map { height: calc(100vh - 64px); width:100%; }
    .popup-actions { display:flex; gap:6px; margin-top:6px; }
    .popup-actions button { padding:4px 6px; font-size:12px; }
  </style>
</head>
<body>

  <div class="controls">
    <input id="addressSearch" placeholder="Search address (Enter)..." />
    <input id="labelSearch" placeholder="Search marker label (Enter)..." />
    <button id="addMarkerBtn">Add Marker</button>
    <button id="trackBtn">Track My GPS</button>
    <button id="routeBtn">Route to Selected</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

  <script>
  (function() {
    const LS_KEY = 'propertyMarkers';
    const urlParams = new URLSearchParams(window.location.search);
    const role = urlParams.get('role') || 'buyer';
    const map = L.map('map').setView([14.5995, 120.9842], 13);
    let markers = [];
    let addingMarker = false;
    let selectedMarker = null;
    let routingControl = null;
    let userMarker = null;

    // map layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2,5); }
    function escapeHtml(s=''){return s.replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));}

    // --- save/load ---
    function saveMarkers(){
      localStorage.setItem(LS_KEY, JSON.stringify(markers.map(m => ({
        id: m._id, label: m._label, lat: m.getLatLng().lat, lng: m.getLatLng().lng
      }))));
    }

    function loadMarkers(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      try {
        JSON.parse(raw).forEach(d=>{
          const m = createMarker([d.lat,d.lng],d.label,d.id);
          markers.push(m);
        });
      } catch(e){console.log(e);}
    }

    function getPopupHTML(m){
      if(role!=='agent') return `<b>${escapeHtml(m._label)}</b>`;
      return `
        <div>
          <label>Label:</label>
          <input id="label-${m._id}" value="${escapeHtml(m._label)}" style="width:100%;margin-top:4px;" />
          <div class="popup-actions">
            <button class="save-btn">Save</button>
            <button class="move-btn">${m._draggable?'Lock':'Move'}</button>
            <button class="delete-btn">Delete</button>
          </div>
        </div>`;
    }

 function attachPopupEvents(m){
  m.on('popupopen',()=>{
    setTimeout(()=>{
      const el = m.getPopup().getElement();
      if(!el) return;
      const saveBtn = el.querySelector('.save-btn');
      const moveBtn = el.querySelector('.move-btn');
      const delBtn = el.querySelector('.delete-btn');
      const input = el.querySelector(`#label-${m._id}`);

      if(saveBtn) saveBtn.onclick = ()=>{
        m._label = input.value.trim()||'Unnamed';
        m.bindPopup(getPopupHTML(m));
        saveMarkers();
        m.openPopup();
      };
      if(moveBtn) moveBtn.onclick = ()=>{
        if(m.dragging.enabled()){
          m.dragging.disable(); m._draggable=false;
        } else {
          m.dragging.enable(); m._draggable=true;
          m.on('dragend',()=>saveMarkers());
        }
        m.bindPopup(getPopupHTML(m));
        m.openPopup();
        saveMarkers();
      };
      if(delBtn) delBtn.onclick = ()=>{
        if(!confirm('Delete this marker?'))return;
        map.removeLayer(m);
        markers = markers.filter(x=>x._id!==m._id);
        saveMarkers();
      };
    }, 0);
  });
}
    function createMarker(latlng,label='Unnamed',id=null){
      const m=L.marker(latlng,{draggable:false}).addTo(map);
      m._id=id||genId(); m._label=label; m._draggable=false;
      m.bindPopup(getPopupHTML(m));
      attachPopupEvents(m);
      m.on('click',()=>{selectedMarker=m; m.openPopup();});
      return m;
    }

    // --- add marker ---
    const addMarkerBtn=document.getElementById('addMarkerBtn');
    if(role!=='agent') addMarkerBtn.style.display='none';
    addMarkerBtn.onclick=()=>{
      if(role!=='agent')return;
      addingMarker=!addingMarker;
      addMarkerBtn.textContent=addingMarker?'Click map to place marker...':'Add Marker';
      if(addingMarker){
        map.once('click',e=>{
          const m=createMarker(e.latlng,'New Marker');
          markers.push(m); saveMarkers();
          addingMarker=false; addMarkerBtn.textContent='Add Marker';
        });
      }
    };

    // --- search address ---
    document.getElementById('addressSearch').addEventListener('keydown',async e=>{
      if(e.key!=='Enter')return;
      const q=e.target.value.trim();
      if(!q)return;
      const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
      const data=await res.json();
      if(!data.length)return alert('Address not found');
      const {lat,lon,display_name}=data[0];
      map.setView([+lat,+lon],15);
      L.popup().setLatLng([+lat,+lon]).setContent(`<b>${escapeHtml(display_name)}</b>`).openOn(map);
    });

    // --- search label ---
    document.getElementById('labelSearch').addEventListener('keydown',e=>{
      if(e.key!=='Enter')return;
      const q=e.target.value.trim().toLowerCase();
      if(!q)return;
      const found=markers.find(m=>(m._label||'').toLowerCase().includes(q));
      if(!found)return alert('No marker found');
      map.setView(found.getLatLng(),16); found.openPopup();
    });

    // --- load markers ---
    loadMarkers();

    // --- GPS track ---
    document.getElementById('trackBtn').onclick=()=>{
      if(!navigator.geolocation)return alert('Not supported');
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude,lng=pos.coords.longitude;
        if(!userMarker) userMarker=L.marker([lat,lng]).addTo(map).bindPopup('You are here').openPopup();
        else userMarker.setLatLng([lat,lng]).openPopup();
        map.setView([lat,lng],15);
      });
    };

    // --- route ---
    document.getElementById('routeBtn').onclick=()=>{
      if(!selectedMarker)return alert('Click a marker first');
      if(!navigator.geolocation)return alert('Not supported');
      navigator.geolocation.getCurrentPosition(pos=>{
        const start=L.latLng(pos.coords.latitude,pos.coords.longitude);
        const end=selectedMarker.getLatLng();
        if(routingControl) map.removeControl(routingControl);
        routingControl=L.Routing.control({
          waypoints:[start,end],
          routeWhileDragging:false,
          createMarker:()=>null,
          lineOptions:{styles:[{color:'#2563eb',weight:5}]}
        }).addTo(map);
      });
    };

  })();
  </script>
</body>
</html>
